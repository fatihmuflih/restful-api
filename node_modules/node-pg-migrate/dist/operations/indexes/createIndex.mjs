import { dropIndex } from "./dropIndex";
import { generateColumnsString, generateIndexName } from "./shared";
function createIndex(mOptions) {
  const _create = (tableName, rawColumns, options = {}) => {
    const columns = Array.isArray(rawColumns) ? rawColumns.slice() : [rawColumns];
    if (options.opclass) {
      mOptions.logger.warn(
        "Using opclass is deprecated. You should use it as part of column definition e.g. pgm.createIndex('table', [['column', 'opclass', 'ASC']])"
      );
      const lastIndex = columns.length - 1;
      const lastColumn = columns[lastIndex];
      if (typeof lastColumn === "string") {
        columns[lastIndex] = { name: lastColumn, opclass: options.opclass };
      } else if (lastColumn.opclass) {
        throw new Error(
          "There is already defined opclass on column, can't override it with global one"
        );
      } else {
        columns[lastIndex] = { ...lastColumn, opclass: options.opclass };
      }
    }
    const indexName = generateIndexName(
      typeof tableName === "object" ? tableName.name : tableName,
      columns,
      options,
      mOptions.schemalize
    );
    const columnsString = generateColumnsString(columns, mOptions);
    const unique = options.unique ? " UNIQUE" : "";
    const concurrently = options.concurrently ? " CONCURRENTLY" : "";
    const ifNotExistsStr = options.ifNotExists ? " IF NOT EXISTS" : "";
    const method = options.method ? ` USING ${options.method}` : "";
    const where = options.where ? ` WHERE ${options.where}` : "";
    const include = options.include ? ` INCLUDE (${(Array.isArray(options.include) ? options.include : [options.include]).map(mOptions.literal).join(", ")})` : "";
    const indexNameStr = mOptions.literal(indexName);
    const tableNameStr = mOptions.literal(tableName);
    return `CREATE${unique} INDEX${concurrently}${ifNotExistsStr} ${indexNameStr} ON ${tableNameStr}${method} (${columnsString})${include}${where};`;
  };
  _create.reverse = dropIndex(mOptions);
  return _create;
}
export {
  createIndex
};
